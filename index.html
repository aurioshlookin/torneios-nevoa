<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Central de Torneios</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body class="bg-slate-900 text-white font-sans min-h-screen flex flex-col">

    <!-- Navbar -->
    <nav class="bg-slate-800 p-4 border-b border-slate-700">
        <div class="container mx-auto flex justify-between items-center">
            <h1 class="text-2xl font-bold text-yellow-500"><i class="fas fa-trophy"></i> Arena Hub</h1>
            <div id="auth-container">
                <!-- BotÃ£o de Login (VisÃ­vel apenas na tela de login, mas mantido aqui para controle) -->
                <div id="user-info" class="hidden flex items-center gap-3">
                    <img id="user-avatar" src="" class="w-8 h-8 rounded-full border border-slate-600">
                    <span id="username" class="font-medium"></span>
                    <button id="logout-btn" class="text-sm text-red-400 hover:text-red-300 ml-2">
                        <i class="fas fa-sign-out-alt"></i> Sair
                    </button>
                </div>
            </div>
        </div>
    </nav>

    <!-- Tela de Login (Aparece se nÃ£o estiver logado) -->
    <div id="login-screen" class="flex-grow flex flex-col items-center justify-center p-6 text-center">
        <div class="bg-slate-800 p-8 rounded-lg shadow-xl border border-slate-700 max-w-md w-full">
            <div class="text-5xl text-yellow-500 mb-4">
                <i class="fas fa-lock"></i>
            </div>
            <h2 class="text-2xl font-bold mb-2">Acesso Restrito</h2>
            <p class="text-slate-400 mb-6">FaÃ§a login com sua conta do Discord para visualizar e gerenciar os torneios.</p>
            
            <button id="login-btn" class="w-full bg-[#5865F2] hover:bg-[#4752C4] text-white font-bold py-3 px-4 rounded transition flex items-center justify-center gap-2">
                <i class="fab fa-discord"></i> Entrar com Discord
            </button>
            
            <div id="loading-btn" class="hidden w-full bg-slate-700 text-slate-300 font-bold py-3 px-4 rounded flex items-center justify-center gap-2 cursor-wait">
                <i class="fas fa-spinner fa-spin"></i> Conectando...
            </div>
        </div>
    </div>

    <!-- Ãrea Principal (Aparece APENAS se estiver logado) -->
    <main id="main-content" class="hidden container mx-auto p-6 flex-grow">
        
        <!-- Painel Admin -->
        <section id="admin-panel" class="hidden mb-10 bg-slate-800 p-6 rounded-lg border border-slate-700 shadow-lg relative overflow-hidden">
            <div class="absolute top-0 right-0 p-4 opacity-10 pointer-events-none">
                <i class="fas fa-crown text-9xl text-yellow-500"></i>
            </div>
            <h2 class="text-xl font-bold mb-4 text-green-400 border-b border-slate-700 pb-2">
                <i class="fas fa-plus-circle"></i> Criar Novo Torneio
            </h2>
            <form id="create-tournament-form" class="grid gap-4 md:grid-cols-2 relative z-10">
                <div class="col-span-2">
                    <label class="block text-sm text-slate-400 mb-1 font-bold">TÃ­tulo do Evento</label>
                    <input type="text" id="t-title" required placeholder="Ex: Torneio de SÃ¡bado" class="w-full bg-slate-900 border border-slate-600 rounded p-2 focus:border-yellow-500 outline-none text-white placeholder-slate-600 transition">
                </div>
                <div>
                    <label class="block text-sm text-slate-400 mb-1 font-bold">Data/Hora</label>
                    <input type="text" id="t-date" placeholder="Ex: SÃ¡bado Ã s 19h" required class="w-full bg-slate-900 border border-slate-600 rounded p-2 focus:border-yellow-500 outline-none text-white placeholder-slate-600 transition">
                </div>
                <div class="col-span-2">
                    <label class="block text-sm text-slate-400 mb-1 font-bold">DescriÃ§Ã£o</label>
                    <textarea id="t-desc" rows="3" placeholder="Detalhes, regras, prÃªmios..." required class="w-full bg-slate-900 border border-slate-600 rounded p-2 focus:border-yellow-500 outline-none text-white placeholder-slate-600 transition"></textarea>
                </div>
                <button type="submit" class="col-span-2 bg-green-600 hover:bg-green-700 text-white font-bold py-3 rounded mt-2 shadow-lg transition transform hover:scale-[1.01] active:scale-95">
                    LanÃ§ar Torneio ðŸš€
                </button>
            </form>
        </section>

        <!-- Lista -->
        <div class="flex items-center gap-3 mb-6">
            <h2 class="text-2xl font-bold border-l-4 border-yellow-500 pl-3">Torneios Ativos</h2>
            <div id="loader-tournaments" class="hidden text-yellow-500"><i class="fas fa-sync fa-spin"></i></div>
        </div>
        
        <div id="tournaments-list" class="grid gap-6 md:grid-cols-2 lg:grid-cols-3">
            <!-- Cards serÃ£o injetados aqui -->
        </div>
    </main>

    <!-- Footer -->
    <footer class="bg-slate-900 text-slate-600 text-center p-4 text-xs border-t border-slate-800 mt-auto">
        &copy; 2024 Arena Hub - Sistema de Torneios
    </footer>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, addDoc, query, orderBy, onSnapshot } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        import { getAuth, signInWithCustomToken, signOut, onAuthStateChanged, setPersistence, browserLocalPersistence } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getAnalytics } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-analytics.js";

        // --- CONFIGURAÃ‡ÃƒO ---
        const firebaseConfig = {
            apiKey: "AIzaSyBFR5q22-9AIGJYN6fFFJVV3p9LH6p5Ma8",
            authDomain: "torneios-nin.firebaseapp.com",
            projectId: "torneios-nin",
            storageBucket: "torneios-nin.firebasestorage.app",
            messagingSenderId: "466171413764",
            appId: "1:466171413764:web:77e537310a16c391193c51",
            measurementId: "G-L166F59V2D"
        };
        
        // --- DADOS DO DISCORD ---
        const DISCORD_CLIENT_ID = "1453817939265589452"; 
        
        // --- URL DO SEU BOT NA SQUARE CLOUD ---
        const BOT_API_URL = "https://torneionevoa.squareweb.app/auth/discord";

        // --- ADICIONE SEU ID AQUI PARA TER PERMISSÃƒO DE CRIAR ---
        // VocÃª pode ver seu ID no console do navegador (F12) apÃ³s logar
        const ADMIN_IDS = ["SEU_ID_DISCORD_AQUI", "1410456333391761462", "1410661305227935875"]; 

        const app = initializeApp(firebaseConfig);
        const analytics = getAnalytics(app);
        const db = getFirestore(app);
        const auth = getAuth(app);

        // Define persistÃªncia LOCAL (Login dura mesmo fechando a aba)
        setPersistence(auth, browserLocalPersistence).catch(error => {
            console.error("Erro na persistÃªncia:", error);
        });

        // Elementos UI
        const loginBtn = document.getElementById('login-btn');
        const loadingBtn = document.getElementById('loading-btn');
        const logoutBtn = document.getElementById('logout-btn');
        const userInfo = document.getElementById('user-info');
        const loginScreen = document.getElementById('login-screen');
        const mainContent = document.getElementById('main-content');
        const adminPanel = document.getElementById('admin-panel');
        const form = document.getElementById('create-tournament-form');
        const list = document.getElementById('tournaments-list');
        const loaderTournaments = document.getElementById('loader-tournaments');

        // --- LÃ“GICA DE LOGIN ---
        loginBtn.addEventListener('click', () => {
            const redirectUri = window.location.origin + window.location.pathname;
            const authUrl = `https://discord.com/api/oauth2/authorize?client_id=${DISCORD_CLIENT_ID}&redirect_uri=${encodeURIComponent(redirectUri)}&response_type=code&scope=identify`;
            window.location.href = authUrl;
        });

        // Callback do Login (Code from Discord)
        window.addEventListener('load', async () => {
            const params = new URLSearchParams(window.location.search);
            const code = params.get('code');

            if (code) {
                // Limpa URL
                window.history.replaceState({}, document.title, window.location.pathname);
                
                toggleLoginLoading(true);

                try {
                    const redirectUri = window.location.origin + window.location.pathname;
                    const response = await fetch(BOT_API_URL, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ code, redirectUri })
                    });

                    if (!response.ok) {
                        const errText = await response.text();
                        throw new Error(`Falha API Bot: ${errText}`);
                    }

                    const data = await response.json();
                    await signInWithCustomToken(auth, data.token);
                    // O onAuthStateChanged vai lidar com o resto
                    
                } catch (error) {
                    console.error("Erro login:", error);
                    alert("Erro ao logar: " + error.message);
                    toggleLoginLoading(false);
                }
            }
        });

        function toggleLoginLoading(isLoading) {
            if(isLoading) {
                loginBtn.classList.add('hidden');
                loadingBtn.classList.remove('hidden');
            } else {
                loginBtn.classList.remove('hidden');
                loadingBtn.classList.add('hidden');
            }
        }

        logoutBtn.addEventListener('click', () => signOut(auth));

        // --- MONITOR DE ESTADO DO USUÃRIO ---
        onAuthStateChanged(auth, (user) => {
            // Se estiver na tela de loading do login, reseta
            toggleLoginLoading(false);

            if (user) {
                // LOGADO
                loginScreen.classList.add('hidden');
                mainContent.classList.remove('hidden'); // Mostra o conteÃºdo principal
                userInfo.classList.remove('hidden');
                
                const discordId = user.uid;
                console.log("UsuÃ¡rio logado ID:", discordId); // Debug para vocÃª ver seu ID

                document.getElementById('username').innerText = user.displayName || "UsuÃ¡rio";
                document.getElementById('user-avatar').src = user.photoURL || `https://cdn.discordapp.com/embed/avatars/0.png`;

                if (ADMIN_IDS.includes(discordId)) {
                    console.log("Modo Admin ATIVADO");
                    adminPanel.classList.remove('hidden');
                } else {
                    console.log("Modo Admin DESATIVADO (ID nÃ£o estÃ¡ na lista)");
                }
                
                // Inicia listener de torneios apenas quando logado
                iniciarListenerTorneios();

            } else {
                // DESLOGADO
                loginScreen.classList.remove('hidden'); // Mostra tela de login
                mainContent.classList.add('hidden');    // Esconde conteÃºdo
                userInfo.classList.add('hidden');
                adminPanel.classList.add('hidden');
                list.innerHTML = ""; // Limpa lista por seguranÃ§a
            }
        });

        // --- CRIAR TORNEIO ---
        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            // Verifica auth de novo por seguranÃ§a
            if(!auth.currentUser) return alert("VocÃª precisa estar logado.");

            const btn = form.querySelector('button');
            const originalText = btn.innerText;
            btn.disabled = true;
            btn.innerText = "Enviando...";

            const title = document.getElementById('t-title').value;
            const date = document.getElementById('t-date').value;
            const desc = document.getElementById('t-desc').value;

            try {
                console.log("Tentando criar torneio:", { title, date, desc });
                
                await addDoc(collection(db, "tournaments"), {
                    title, 
                    date, 
                    description: desc,
                    status: "pending", 
                    createdAt: new Date(), 
                    createdBy: auth.currentUser.uid,
                    creatorName: auth.currentUser.displayName,
                    participants: []
                });
                
                alert("Torneio enviado para o Bot com sucesso!");
                form.reset();
            } catch (error) { 
                console.error("Erro Firestore:", error);
                alert("Erro ao criar torneio: " + error.message); 
            } finally {
                btn.disabled = false;
                btn.innerText = originalText;
            }
        });

        // --- LISTAR TORNEIOS ---
        let unsubscribeTorneios = null;

        function iniciarListenerTorneios() {
            if(unsubscribeTorneios) return; // JÃ¡ estÃ¡ ouvindo

            loaderTournaments.classList.remove('hidden');
            const q = query(collection(db, "tournaments"), orderBy("createdAt", "desc"));
            
            unsubscribeTorneios = onSnapshot(q, (snapshot) => {
                loaderTournaments.classList.add('hidden');
                list.innerHTML = "";
                
                if (snapshot.empty) {
                    list.innerHTML = `
                        <div class="col-span-full text-center p-10 bg-slate-800 rounded-lg border border-slate-700 border-dashed opacity-70">
                            <i class="fas fa-wind text-4xl mb-3 text-slate-500"></i>
                            <p class="text-slate-400">Nenhum torneio ativo no momento.</p>
                        </div>
                    `;
                    return;
                }

                snapshot.forEach((doc) => {
                    const data = doc.data();
                    if(data.status === 'finished') return;
                    
                    const conf = (data.participants||[]).filter(p=>p.status==='confirmed').length;
                    const maybe = (data.participants||[]).filter(p=>p.status==='maybe').length;
                    const declined = (data.participants||[]).filter(p=>p.status==='declined').length;
                    
                    // Status Badge Logic
                    let statusHtml = '';
                    if(data.status === 'pending') {
                        statusHtml = '<span class="bg-yellow-900 text-yellow-300 text-xs px-2 py-1 rounded border border-yellow-700 animate-pulse"><i class="fas fa-cog fa-spin"></i> Processando...</span>';
                    } else {
                        statusHtml = '<span class="bg-green-900 text-green-300 text-xs px-2 py-1 rounded border border-green-700">Aberto</span>';
                    }

                    list.innerHTML += `
                        <div class="bg-slate-800 rounded-lg border border-slate-700 p-0 overflow-hidden hover:border-yellow-500 transition shadow-lg group flex flex-col h-full">
                            <div class="p-5 flex-grow">
                                <div class="flex justify-between items-start mb-3">
                                    <h3 class="font-bold text-lg text-white group-hover:text-yellow-400 transition">${data.title}</h3>
                                    ${statusHtml}
                                </div>
                                
                                <div class="flex items-center gap-2 text-sm text-yellow-500 mb-3 bg-slate-900/50 p-2 rounded w-fit">
                                    <i class="far fa-calendar-alt"></i>
                                    <span>${data.date}</span>
                                </div>

                                <p class="text-slate-400 text-sm mb-4 line-clamp-3">${data.description}</p>
                            </div>

                            <div class="bg-slate-900/80 p-3 border-t border-slate-700 grid grid-cols-3 gap-2 text-center text-xs">
                                <div class="text-green-400 font-bold bg-slate-800 p-1 rounded" title="Confirmados">
                                    <i class="fas fa-check mb-1 block"></i> ${conf}
                                </div>
                                <div class="text-yellow-400 font-bold bg-slate-800 p-1 rounded" title="Talvez">
                                    <i class="fas fa-question mb-1 block"></i> ${maybe}
                                </div>
                                <div class="text-red-400 font-bold bg-slate-800 p-1 rounded" title="NÃ£o vÃ£o">
                                    <i class="fas fa-times mb-1 block"></i> ${declined}
                                </div>
                            </div>
                        </div>
                    `;
                });
            }, (error) => {
                console.error("Erro ao buscar torneios:", error);
                loaderTournaments.classList.add('hidden');
                list.innerHTML = `<p class="text-red-400 col-span-full">Erro ao carregar torneios: ${error.message}</p>`;
            });
        }
    </script>
</body>
</html>
