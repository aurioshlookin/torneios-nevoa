<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    
    <title>Torneios da N√©voa</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #1e293b; }
        ::-webkit-scrollbar-thumb { background: #475569; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #64748b; }
        .card-controls { z-index: 50; }
        .glass-panel { background: rgba(30, 41, 59, 0.95); backdrop-filter: blur(10px); }
        .fade-enter { opacity: 0; transform: translateY(10px); }
        .fade-enter-active { opacity: 1; transform: translateY(0); transition: opacity 300ms, transform 300ms; }
        
        /* Anima√ß√£o do Toast */
        @keyframes slideInRight {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        .toast { animation: slideInRight 0.3s ease-out forwards; }
    </style>
</head>
<body class="bg-slate-900 text-white font-sans min-h-screen flex flex-col">

    <!-- Container de Toasts (Notifica√ß√µes) -->
    <div id="toast-container" class="fixed top-20 right-5 z-[100] flex flex-col gap-3"></div>

    <!-- Navbar -->
    <nav class="bg-slate-800 p-4 border-b border-slate-700 sticky top-0 z-50 shadow-md">
        <div class="container mx-auto flex justify-between items-center">
            <h1 class="text-2xl font-bold text-yellow-500 tracking-wider flex items-center gap-2">
                <i class="fas fa-khanda text-3xl"></i>
                <span>Torneios da N√©voa</span>
            </h1>
            <div id="auth-container" class="flex items-center gap-4">
                <button id="new-event-btn" class="hidden bg-green-600 hover:bg-green-500 text-white px-4 py-2 rounded-full font-bold shadow-lg transition flex items-center gap-2 transform hover:scale-105">
                    <i class="fas fa-plus"></i> <span class="hidden sm:inline">Novo Evento</span>
                </button>

                <button id="settings-btn" class="hidden text-slate-400 hover:text-white transition p-2 rounded hover:bg-slate-700" title="Configura√ß√µes"><i class="fas fa-cog fa-lg"></i></button>
                <div id="user-info" class="hidden flex items-center gap-3 bg-slate-700/50 pr-4 pl-1 py-1 rounded-full border border-slate-600">
                    <img id="user-avatar" src="" class="w-8 h-8 rounded-full border border-yellow-500 object-cover bg-slate-800" onerror="this.src='https://cdn.discordapp.com/embed/avatars/0.png'">
                    <span id="username" class="font-medium text-sm"></span>
                    <button id="logout-btn" class="text-xs text-red-400 hover:text-red-300 ml-2 border-l border-slate-600 pl-3">SAIR</button>
                </div>
            </div>
        </div>
    </nav>

    <!-- Modal Novo Evento -->
    <div id="create-modal" class="hidden fixed inset-0 bg-black/80 z-[60] flex items-center justify-center backdrop-blur-sm p-4">
        <div class="bg-slate-800 w-full max-w-2xl rounded-xl border border-slate-600 shadow-2xl overflow-hidden flex flex-col max-h-[90vh]">
            <div class="p-4 border-b border-slate-700 flex justify-between items-center bg-slate-900/50">
                <h3 class="font-bold text-lg text-green-400"><i class="fas fa-calendar-plus mr-2"></i>Agendar Evento</h3>
                <button onclick="document.getElementById('create-modal').classList.add('hidden')" class="text-slate-400 hover:text-white"><i class="fas fa-times"></i></button>
            </div>
            
            <div class="p-6 overflow-y-auto flex-grow">
                <form id="create-tournament-form" class="space-y-4">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-xs uppercase tracking-wider text-slate-500 mb-1 font-bold ml-1">T√≠tulo</label>
                            <input type="text" id="t-title" required placeholder="Ex: Exame Chunin" class="w-full bg-slate-900 border border-slate-700 rounded-lg p-3 focus:border-green-500 outline-none transition">
                        </div>
                        <div>
                            <label class="block text-xs uppercase tracking-wider text-slate-500 mb-1 font-bold ml-1">Data/Hor√°rio</label>
                            <input type="text" id="t-date" placeholder="Ex: S√°bado √†s 19:00" required class="w-full bg-slate-900 border border-slate-700 rounded-lg p-3 focus:border-green-500 outline-none transition">
                        </div>
                    </div>

                    <!-- Configura√ß√µes Avan√ßadas -->
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-3 bg-slate-900/50 p-4 rounded-lg border border-slate-700/50">
                        <div>
                            <label class="block text-xs uppercase text-slate-400 mb-1 font-bold">Formato Partida</label>
                            <select id="t-match-format" class="w-full bg-slate-800 border border-slate-600 rounded p-2 text-sm focus:border-green-500 outline-none cursor-pointer hover:bg-slate-700 transition">
                                <option value="1x1">1x1 (Duelo)</option>
                                <option value="2x2">2x2 (Duplas)</option>
                                <option value="3x3">3x3 (Times)</option>
                                <option value="4x4">4x4+ (Equipes)</option>
                                <option value="ffa">Todos contra todos</option>
                                <option value="nmp">Ninja Mais Procurado</option>
                                <option value="nmp_random">NMP Alvo Aleat√≥rio</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-xs uppercase text-slate-400 mb-1 font-bold">Estrutura</label>
                            <select id="t-structure" class="w-full bg-slate-800 border border-slate-600 rounded p-2 text-sm focus:border-green-500 outline-none cursor-pointer hover:bg-slate-700 transition">
                                <option value="single_elim">Elimina√ß√£o Simples</option>
                                <option value="double_elim">Elimina√ß√£o Dupla</option>
                                <option value="swiss">Sistema Su√≠√ßo</option>
                                <option value="groups_playoff">Grupos + Mata-mata</option>
                                <option value="points">Pontua√ß√£o Acumulativa</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-xs uppercase text-slate-400 mb-1 font-bold">Embaralhamento</label>
                            <select id="t-shuffle" class="w-full bg-slate-800 border border-slate-600 rounded p-2 text-sm focus:border-green-500 outline-none cursor-pointer hover:bg-slate-700 transition">
                                <option value="random">Aleat√≥rio Puro</option>
                                <option value="order">Ordem Inscri√ß√£o</option>
                                <option value="random_protected">Aleat√≥rio Protegido</option>
                                <option value="ranking">Por Ranking</option>
                                <option value="mirror">Espelhamento</option>
                                <option value="thematic">Tem√°tico</option>
                                <option value="narrative">Narrativo</option>
                            </select>
                        </div>
                        <!-- √Årea de Descri√ß√£o Din√¢mica -->
                        <div class="col-span-full mt-2">
                            <p id="format-description" class="text-xs text-yellow-500/80 italic border-l-2 border-yellow-500 pl-2">
                                Duelo individual. Foco total em habilidade, leitura e execu√ß√£o.
                            </p>
                        </div>
                    </div>

                    <div>
                        <label class="block text-xs uppercase tracking-wider text-slate-500 mb-1 font-bold ml-1">Descri√ß√£o / Regras</label>
                        <textarea id="t-desc" rows="4" placeholder="Regras espec√≠ficas, premia√ß√£o, mapa..." required class="w-full bg-slate-900 border border-slate-700 rounded-lg p-3 focus:border-green-500 outline-none transition"></textarea>
                    </div>
                </form>
            </div>

            <div class="p-4 border-t border-slate-700 bg-slate-900/50 flex justify-end gap-3">
                <button onclick="document.getElementById('create-modal').classList.add('hidden')" class="text-slate-400 hover:text-white font-bold px-4">Cancelar</button>
                <button onclick="document.getElementById('create-tournament-form').dispatchEvent(new Event('submit'))" class="bg-green-600 hover:bg-green-500 text-white font-bold py-2 px-6 rounded-lg shadow-lg hover:shadow-green-500/20 transition flex items-center gap-2 transform hover:scale-105 active:scale-95">
                    Publicar <i class="fas fa-paper-plane"></i>
                </button>
            </div>
        </div>
    </div>

    <!-- Modal Permiss√µes -->
    <div id="settings-modal" class="hidden fixed inset-0 bg-black/80 z-[60] flex items-center justify-center backdrop-blur-sm p-4">
        <div class="bg-slate-800 w-full max-w-lg rounded-xl border border-slate-600 shadow-2xl overflow-hidden flex flex-col max-h-[80vh]">
            <div class="p-4 border-b border-slate-700 flex justify-between items-center bg-slate-900/50">
                <h3 class="font-bold text-lg">Quem pode criar torneio?</h3>
                <button onclick="document.getElementById('settings-modal').classList.add('hidden')" class="text-slate-400 hover:text-white"><i class="fas fa-times"></i></button>
            </div>
            <div class="p-6 overflow-y-auto flex-grow">
                <div id="roles-list-loader" class="text-center py-4"><i class="fas fa-spinner fa-spin text-yellow-500"></i> Carregando...</div>
                <div id="roles-list" class="space-y-2"></div>
            </div>
            <div class="p-4 border-t border-slate-700 bg-slate-900/50 flex justify-end">
                <button id="save-permissions-btn" class="bg-green-600 hover:bg-green-700 text-white px-6 py-2 rounded font-bold transition">Salvar</button>
            </div>
        </div>
    </div>

    <!-- Modal Detalhes do Evento -->
    <div id="details-modal" class="hidden fixed inset-0 bg-black/90 z-[70] flex items-center justify-center backdrop-blur-sm p-4">
        <div class="bg-slate-800 w-full max-w-3xl rounded-xl border border-slate-600 shadow-2xl overflow-hidden flex flex-col max-h-[90vh]">
            <div class="p-6 border-b border-slate-700 bg-slate-900/80 relative">
                <button onclick="document.getElementById('details-modal').classList.add('hidden')" class="absolute top-4 right-4 text-slate-400 hover:text-white"><i class="fas fa-times fa-lg"></i></button>
                <div class="pr-8">
                    <h2 id="modal-title" class="text-2xl font-bold text-white mb-2">Carregando...</h2>
                    <div class="flex flex-wrap gap-3 text-sm text-slate-300">
                        <span class="bg-slate-700/50 px-2 py-1 rounded"><i class="far fa-clock text-yellow-500 mr-1"></i> <span id="modal-date">...</span></span>
                        <span id="modal-status-badge"></span>
                        <span id="modal-format-badge" class="bg-blue-900/30 border border-blue-500/30 text-blue-300 px-2 py-1 rounded text-xs uppercase font-bold"></span>
                    </div>
                </div>
                <div id="modal-admin-controls" class="mt-4 flex gap-2 hidden"></div>
            </div>

            <div class="flex-grow overflow-y-auto p-6 grid md:grid-cols-3 gap-6">
                <div class="md:col-span-2 space-y-6">
                    <div>
                        <h4 class="text-sm font-bold text-slate-500 uppercase tracking-wider mb-2">Sobre o Evento</h4>
                        <p id="modal-desc" class="text-slate-300 leading-relaxed whitespace-pre-wrap bg-slate-900/50 p-4 rounded-lg border border-slate-700/50">...</p>
                        <div id="modal-format-desc" class="mt-2 text-xs text-yellow-500/80 italic border-l-2 border-yellow-500 pl-2"></div>
                    </div>
                    <div id="modal-join-area" class="border-t border-slate-700 pt-4"></div>
                </div>

                <div class="space-y-6 bg-slate-900/30 p-4 rounded-lg border border-slate-700/30 h-fit">
                    <div>
                        <h4 class="text-sm font-bold text-green-400 uppercase tracking-wider mb-2 border-b border-green-500/20 pb-1 flex justify-between">Confirmados <span id="count-confirmed" class="bg-green-500/10 px-2 rounded text-xs py-0.5">0</span></h4>
                        <div id="list-confirmed" class="space-y-1 max-h-40 overflow-y-auto text-sm"></div>
                    </div>
                    <div>
                        <h4 class="text-sm font-bold text-yellow-400 uppercase tracking-wider mb-2 border-b border-yellow-500/20 pb-1 flex justify-between">Talvez <span id="count-maybe" class="bg-yellow-500/10 px-2 rounded text-xs py-0.5">0</span></h4>
                        <div id="list-maybe" class="space-y-1 max-h-32 overflow-y-auto text-sm"></div>
                    </div>
                    <div>
                        <h4 class="text-sm font-bold text-red-400 uppercase tracking-wider mb-2 border-b border-red-500/20 pb-1 flex justify-between">Ausentes <span id="count-declined" class="bg-red-500/10 px-2 rounded text-xs py-0.5">0</span></h4>
                        <div id="list-declined" class="space-y-1 max-h-32 overflow-y-auto text-sm"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Iniciar Torneio (Aprimorado) -->
    <div id="start-modal" class="hidden fixed inset-0 bg-black/90 z-[80] flex items-center justify-center backdrop-blur-sm p-4">
        <div class="bg-slate-800 w-full max-w-lg rounded-xl border border-slate-600 shadow-2xl overflow-hidden">
            <div class="p-4 border-b border-slate-700 bg-slate-900/50">
                <h3 class="font-bold text-lg text-white"><i class="fas fa-play-circle text-green-500 mr-2"></i>Iniciar Torneio</h3>
            </div>
            <div class="p-6 space-y-5">
                <input type="hidden" id="start-doc-id">
                
                <div class="bg-blue-900/20 border border-blue-500/30 p-3 rounded text-sm text-blue-200 mb-4 flex items-start gap-2">
                    <i class="fas fa-info-circle mt-1"></i>
                    <div>Voc√™ pode editar os formatos finais antes de gerar. <br> <span class="text-xs opacity-70">Essas altera√ß√µes ser√£o salvas no evento.</span></div>
                </div>

                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-xs font-bold text-slate-400 mb-1">Formato Partida</label>
                        <select id="start-match-format" class="w-full bg-slate-900 border border-slate-600 rounded p-2 text-sm focus:border-green-500 outline-none">
                            <option value="1x1">1x1</option>
                            <option value="2x2">2x2</option>
                            <option value="3x3">3x3</option>
                            <option value="4x4">4x4+</option>
                            <option value="ffa">Todos contra todos</option>
                            <option value="nmp">Ninja Mais Procurado</option>
                            <option value="nmp_random">NMP Alvo Aleat√≥rio</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-slate-400 mb-1">Estrutura</label>
                        <select id="start-structure" class="w-full bg-slate-900 border border-slate-600 rounded p-2 text-sm focus:border-green-500 outline-none">
                            <option value="single_elim">Elimina√ß√£o Simples</option>
                            <option value="double_elim">Elimina√ß√£o Dupla</option>
                            <option value="swiss">Sistema Su√≠√ßo</option>
                            <option value="groups_playoff">Grupos + Mata-mata</option>
                            <option value="points">Pontua√ß√£o Acumulativa</option>
                        </select>
                    </div>
                </div>

                <div>
                    <label class="block text-xs font-bold text-slate-400 mb-1">Embaralhamento</label>
                    <select id="start-shuffle" class="w-full bg-slate-900 border border-slate-600 rounded p-2 text-sm focus:border-green-500 outline-none">
                        <option value="random">Aleat√≥rio Puro</option>
                        <option value="order">Ordem de Inscri√ß√£o</option>
                        <option value="random_protected">Aleat√≥rio Protegido</option>
                        <option value="ranking">Por Ranking</option>
                        <option value="mirror">Espelhamento</option>
                        <option value="thematic">Tem√°tico</option>
                        <option value="narrative">Narrativo</option>
                    </select>
                </div>

                <div>
                    <label class="block text-xs font-bold text-slate-400 mb-1">Mec√¢nica do Site (Como gerar?)</label>
                    <select id="start-logic-mode" class="w-full bg-slate-900 border border-slate-600 rounded p-2 text-sm focus:border-green-500 outline-none">
                        <option value="elimination">‚öîÔ∏è Gerar Chaves Autom√°ticas (Mata-mata)</option>
                        <option value="battleroyale">üî• Apenas Listar / Manual</option>
                    </select>
                    <p class="text-[10px] text-slate-500 mt-1">"Gerar Chaves" s√≥ funciona bem para Elimina√ß√£o Simples por enquanto. Para outros modos complexos, use "Apenas Listar".</p>
                </div>

            </div>
            <div class="p-4 border-t border-slate-700 bg-slate-900/50 flex justify-end gap-3">
                <button onclick="document.getElementById('start-modal').classList.add('hidden')" class="text-slate-400 hover:text-white font-bold px-4">Cancelar</button>
                <button id="confirm-start-btn" class="bg-green-600 hover:bg-green-500 text-white px-6 py-2 rounded font-bold shadow-lg transition transform hover:scale-105 active:scale-95">INICIAR</button>
            </div>
        </div>
    </div>

    <!-- Login -->
    <div id="login-screen" class="flex-grow flex flex-col items-center justify-center p-6 text-center animate-fade-in">
        <div class="bg-slate-800 p-10 rounded-2xl shadow-2xl border border-slate-700 max-w-md w-full relative overflow-hidden">
            <div class="absolute -top-10 -right-10 w-32 h-32 bg-yellow-500/20 rounded-full blur-3xl"></div>
            <div class="absolute -bottom-10 -left-10 w-32 h-32 bg-blue-500/20 rounded-full blur-3xl"></div>
            <div class="text-6xl text-yellow-500 mb-6 drop-shadow-lg"><i class="fas fa-scroll"></i></div>
            <h2 class="text-3xl font-bold mb-3">Bem-vindo √† N√©voa</h2>
            <p class="text-slate-400 mb-8">Fa√ßa login para gerenciar os eventos.</p>
            <button id="login-btn" class="w-full bg-[#5865F2] hover:bg-[#4752C4] text-white font-bold py-3.5 px-4 rounded-xl transition flex items-center justify-center gap-3 shadow-lg transform hover:scale-105">
                <i class="fab fa-discord text-xl"></i> Entrar com Discord
            </button>
            <div id="loading-btn" class="hidden w-full bg-slate-700 text-slate-300 font-bold py-3.5 rounded-xl flex items-center justify-center gap-2 cursor-wait"><i class="fas fa-circle-notch fa-spin"></i> Conectando...</div>
        </div>
    </div>

    <!-- App -->
    <main id="main-content" class="hidden container mx-auto p-6 flex-grow">
        <div class="flex items-center gap-4 mb-8">
            <h2 class="text-3xl font-bold text-white tracking-tight">Mural de Eventos</h2>
            <div class="h-1 flex-grow bg-slate-800 rounded-full overflow-hidden"><div class="h-full w-24 bg-yellow-500/50 rounded-full"></div></div>
            <div id="loader-tournaments" class="hidden text-yellow-500"><i class="fas fa-sync fa-spin"></i></div>
        </div>
        <div id="tournaments-list" class="grid gap-6 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4"></div>
    </main>

    <footer class="bg-slate-900 border-t border-slate-800 p-6 text-center mt-auto"><p class="text-slate-500 text-sm">Sistema da N√©voa &bull; Integrado ao Discord</p></footer>

    <!-- Adiciona timestamp para for√ßar recarregamento do script -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, addDoc, doc, getDoc, updateDoc, deleteDoc, setDoc, query, orderBy, onSnapshot } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        import { getAuth, signInWithCustomToken, signOut, onAuthStateChanged, setPersistence, browserLocalPersistence } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        
        const firebaseConfig = {
            apiKey: "AIzaSyBFR5q22-9AIGJYN6fFFJVV3p9LH6p5Ma8",
            authDomain: "torneios-nin.firebaseapp.com",
            projectId: "torneios-nin",
            storageBucket: "torneios-nin.firebasestorage.app",
            messagingSenderId: "466171413764",
            appId: "1:466171413764:web:77e537310a16c391193c51"
        };
        const DISCORD_CLIENT_ID = "1453817939265589452"; 
        const BOT_API_URL = "https://torneionevoa.squareweb.app/auth/discord";
        const SUPER_ADMINS = ["170310660167565323", "1410456333391761462", "1410661305227935875"]; 

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        setPersistence(auth, browserLocalPersistence).catch(console.error);

        let currentUserRoles = [];
        let userHasPermission = false;

        // SISTEMA DE NOTIFICA√á√ÉO (TOAST)
        window.showToast = (msg, type = 'success') => {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            
            const icon = type === 'success' ? '<i class="fas fa-check-circle text-green-400 text-xl"></i>' : '<i class="fas fa-exclamation-circle text-red-400 text-xl"></i>';
            const borderClass = type === 'success' ? 'border-green-500/50' : 'border-red-500/50';
            
            toast.className = `toast flex items-center gap-3 bg-slate-800 border ${borderClass} p-4 rounded-lg shadow-xl min-w-[300px] z-50`;
            toast.innerHTML = `
                ${icon}
                <div class="flex-grow font-medium text-sm text-white">${msg}</div>
                <button onclick="this.parentElement.remove()" class="text-slate-500 hover:text-white"><i class="fas fa-times"></i></button>
            `;
            
            container.appendChild(toast);
            setTimeout(() => {
                toast.style.opacity = '0';
                toast.style.transform = 'translateX(100%)';
                toast.style.transition = 'all 0.3s ease-out';
                setTimeout(() => toast.remove(), 300);
            }, 4000);
        };

        // DADOS DE FORMATO (DESCRI√á√ïES)
        const FORMAT_INFO = {
            matches: {
                '1x1': "Duelo individual. Foco total em habilidade, leitura e execu√ß√£o. Simples, r√°pido e direto.",
                '2x2': "Duplas. Valoriza sinergia, comunica√ß√£o e combina√ß√£o de estilos.",
                '3x3': "Times m√©dios. Permite estrat√©gias profundas e pap√©is definidos.",
                '4x4': "Equipes grandes. Foco em coordena√ß√£o, controle de √°rea e decis√µes em grupo.",
                'ffa': "Cada jogador ou time enfrenta todos os outros. Ca√≥tico e divertido.",
                'nmp': "O vencedor permanece na arena at√© ser derrotado. Formato Rei da Mesa.",
                'nmp_random': "Times. Um alvo aleat√≥rio √© escolhido. Ven√ßa derrotando o alvo inimigo."
            },
            structure: {
                'single_elim': "Perdeu, saiu. Ritmo acelerado e decis√£o constante.",
                'double_elim': "Segunda chance para quem perder. Mais justo, mais demorado.",
                'swiss': "Todos jogam v√°rias rodadas. Confrontos ajustados por desempenho.",
                'groups_playoff': "Fase de grupos seguida por mata-mata.",
                'points': "Vit√≥rias rendem pontos ao longo de v√°rias rodadas."
            },
            shuffle: {
                'order': "Pareamentos seguem a ordem de entrada. F√°cil, mas aleat√≥rio.",
                'random': "Sorteio livre. Simples e r√°pido.",
                'random_protected': "Sorteio com restri√ß√µes para evitar confrontos repetidos.",
                'ranking': "Jogadores enfrentam oponentes de for√ßa semelhante.",
                'mirror': "Melhores contra Piores (Espelhamento).",
                'thematic': "Baseado em Cl√£ ou Tema.",
                'narrative': "Confrontos para gerar hist√≥ria e rivalidade."
            }
        };

        // UI Helpers
        const els = {
            loginBtn: document.getElementById('login-btn'), loadingBtn: document.getElementById('loading-btn'),
            loginScreen: document.getElementById('login-screen'), mainContent: document.getElementById('main-content'),
            userInfo: document.getElementById('user-info'), 
            newEventBtn: document.getElementById('new-event-btn'),
            settingsBtn: document.getElementById('settings-btn'), settingsModal: document.getElementById('settings-modal'),
            rolesList: document.getElementById('roles-list'), savePermsBtn: document.getElementById('save-permissions-btn'),
            detailsModal: document.getElementById('details-modal'), 
            startModal: document.getElementById('start-modal'), confirmStartBtn: document.getElementById('confirm-start-btn')
        };

        // --- ATUALIZA DESCRI√á√ïES DINAMICAMENTE NO CREATE ---
        function updateDescription() {
            const m = document.getElementById('t-match-format').value;
            const s = document.getElementById('t-structure').value;
            const h = document.getElementById('t-shuffle').value;
            
            const desc = `${FORMAT_INFO.matches[m] || ''} <br> 
                          <span class="text-slate-500">‚Ä¢ ${FORMAT_INFO.structure[s] || ''}</span> <br> 
                          <span class="text-slate-500">‚Ä¢ ${FORMAT_INFO.shuffle[h] || ''}</span>`;
            document.getElementById('format-description').innerHTML = desc;
        }
        document.getElementById('t-match-format').onchange = updateDescription;
        document.getElementById('t-structure').onchange = updateDescription;
        document.getElementById('t-shuffle').onchange = updateDescription;

        // --- AUTH ---
        els.loginBtn.onclick = () => window.location.href = `https://discord.com/api/oauth2/authorize?client_id=${DISCORD_CLIENT_ID}&redirect_uri=${encodeURIComponent(window.location.origin + window.location.pathname)}&response_type=code&scope=identify`;
        window.addEventListener('load', async () => {
            const code = new URLSearchParams(window.location.search).get('code');
            if (code) {
                window.history.replaceState({}, '', window.location.pathname);
                toggleLoading(true);
                try {
                    const res = await fetch(BOT_API_URL, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ code, redirectUri: window.location.origin + window.location.pathname }) });
                    if (!res.ok) throw new Error(await res.text());
                    const data = await res.json();
                    localStorage.setItem('discord_roles', JSON.stringify(data.roles || []));
                    await signInWithCustomToken(auth, data.token);
                    window.showToast("Login realizado com sucesso!", "success");
                } catch (e) { 
                    console.error(e);
                    window.showToast("Erro ao realizar login.", "error");
                    toggleLoading(false); 
                }
            }
        });
        function toggleLoading(b) { els.loginBtn.classList.toggle('hidden', b); els.loadingBtn.classList.toggle('hidden', !b); }
        document.getElementById('logout-btn').onclick = () => { localStorage.removeItem('discord_roles'); signOut(auth); };

        onAuthStateChanged(auth, async u => {
            toggleLoading(false);
            if (u) {
                els.loginScreen.classList.add('hidden'); els.mainContent.classList.remove('hidden'); els.userInfo.classList.remove('hidden');
                document.getElementById('username').innerText = u.displayName; 
                
                let avatarUrl = u.photoURL;
                if (u.providerData && u.providerData.length > 0 && u.providerData[0].photoURL) {
                    avatarUrl = u.providerData[0].photoURL;
                }
                if(!avatarUrl || avatarUrl.includes('undefined')) avatarUrl = "https://cdn.discordapp.com/embed/avatars/0.png";
                
                document.getElementById('user-avatar').src = avatarUrl;

                try { currentUserRoles = JSON.parse(localStorage.getItem('discord_roles') || "[]"); } catch(e) {}
                await checkPermissions(u.uid);
                startTournamentListener();
                if (SUPER_ADMINS.includes(u.uid)) { els.settingsBtn.classList.remove('hidden'); els.settingsBtn.onclick = openSettingsModal; }
            } else {
                els.loginScreen.classList.remove('hidden'); els.mainContent.classList.add('hidden'); els.userInfo.classList.add('hidden');
                els.newEventBtn.classList.add('hidden'); els.settingsBtn.classList.add('hidden');
            }
        });

        async function checkPermissions(uid) {
            userHasPermission = SUPER_ADMINS.includes(uid);
            if (!userHasPermission) {
                const s = await getDoc(doc(db, "config", "permissions"));
                if (s.exists()) userHasPermission = currentUserRoles.some(r => (s.data().allowed_create_roles || []).includes(r));
            }
            if (userHasPermission) {
                els.newEventBtn.classList.remove('hidden');
                els.newEventBtn.onclick = () => document.getElementById('create-modal').classList.remove('hidden');
            } else {
                els.newEventBtn.classList.add('hidden');
            }
        }

        // --- SETTINGS ---
        async function openSettingsModal() {
            els.settingsModal.classList.remove('hidden');
            document.getElementById('roles-list-loader').classList.remove('hidden'); els.rolesList.innerHTML = "";
            const [rolesSnap, permsSnap] = await Promise.all([getDoc(doc(db, "config", "discord_roles")), getDoc(doc(db, "config", "permissions"))]);
            const allowed = permsSnap.exists() ? (permsSnap.data().allowed_create_roles || []) : [];
            document.getElementById('roles-list-loader').classList.add('hidden');
            if (rolesSnap.exists()) {
                rolesSnap.data().list.forEach(r => {
                    if (r.name !== '@everyone') els.rolesList.innerHTML += `<label class="flex items-center p-3 rounded hover:bg-slate-700/50 cursor-pointer"><input type="checkbox" class="role-checkbox w-5 h-5 rounded text-green-600" value="${r.id}" ${allowed.includes(r.id)?'checked':''}><span class="ml-3 font-medium" style="color:${r.color}">${r.name}</span></label>`;
                });
            } else els.rolesList.innerHTML = "<p class='text-red-400'>Sem cargos. Reinicie o Bot.</p>";
        }
        els.savePermsBtn.onclick = async () => {
            const ids = Array.from(document.querySelectorAll('.role-checkbox:checked')).map(c => c.value);
            els.savePermsBtn.innerText = "Salvando...";
            await setDoc(doc(db, "config", "permissions"), { allowed_create_roles: ids }, { merge: true });
            els.savePermsBtn.innerText = "Salvo!"; setTimeout(() => { els.savePermsBtn.innerText = "Salvar"; els.settingsModal.classList.add('hidden'); if(auth.currentUser) checkPermissions(auth.currentUser.uid); window.showToast("Permiss√µes atualizadas!"); }, 1000);
        };

        // --- CREATE ---
        document.getElementById('create-tournament-form').onsubmit = async (e) => {
            e.preventDefault();
            const btn = e.target.closest('#create-modal').querySelector('button[onclick*="submit"]'); 
            const old = btn.innerHTML;
            btn.disabled = true; btn.innerHTML = '<i class="fas fa-circle-notch fa-spin"></i>';
            try {
                await addDoc(collection(db, "tournaments"), {
                    title: document.getElementById('t-title').value, 
                    date: document.getElementById('t-date').value,
                    description: document.getElementById('t-desc').value,
                    // Novos Campos
                    matchFormat: document.getElementById('t-match-format').value,
                    structure: document.getElementById('t-structure').value,
                    shuffle: document.getElementById('t-shuffle').value,
                    
                    status: "pending",
                    createdAt: new Date(), createdBy: auth.currentUser.uid, participants: []
                });
                window.showToast("Torneio criado e enviado para o Discord!");
                document.getElementById('create-tournament-form').reset();
                document.getElementById('create-modal').classList.add('hidden');
            } catch (err) { window.showToast("Erro ao criar: " + err.message, "error"); }
            finally { btn.disabled = false; btn.innerHTML = old; }
        };

        // --- ACTIONS (DELETE & START & JOIN & DETAILS) ---
        window.deleteTournament = async (id) => {
            if(!confirm("Tem certeza? Isso apagar√° o torneio do site e do Discord.")) return;
            try { 
                await deleteDoc(doc(db, "tournaments", id)); 
                document.getElementById('details-modal').classList.add('hidden');
                window.showToast("Torneio exclu√≠do com sucesso.");
            } catch(e) { window.showToast("Erro: " + e.message, "error"); }
        };

        window.openStartModal = async (id) => {
            document.getElementById('start-doc-id').value = id;
            els.startModal.classList.remove('hidden');
            document.getElementById('details-modal').classList.add('hidden');
            
            // Carregar dados salvos no torneio para preencher o modal
            const docSnap = await getDoc(doc(db, "tournaments", id));
            if (docSnap.exists()) {
                const d = docSnap.data();
                if(d.matchFormat) document.getElementById('start-match-format').value = d.matchFormat;
                if(d.structure) document.getElementById('start-structure').value = d.structure;
                if(d.shuffle) document.getElementById('start-shuffle').value = d.shuffle;
                
                // Sugerir modo l√≥gico baseado na estrutura
                if(d.structure === 'single_elim') document.getElementById('start-logic-mode').value = 'elimination';
                else document.getElementById('start-logic-mode').value = 'battleroyale';
            }
        };

        window.joinTournament = async (id) => {
            try {
                const user = auth.currentUser;
                if(!user) return window.showToast("Voc√™ precisa estar logado.", "error");
                
                const docRef = doc(db, "tournaments", id);
                const snap = await getDoc(docRef);
                if(!snap.exists()) return;
                
                let parts = snap.data().participants || [];
                parts = parts.filter(p => p.id !== user.uid);
                parts.push({ id: user.uid, name: user.displayName, status: 'confirmed' });
                
                await updateDoc(docRef, { participants: parts });
                window.openDetails(id);
                window.showToast("Inscri√ß√£o confirmada!", "success");
            } catch(e) { console.error(e); window.showToast("Erro ao entrar: " + e.message, "error"); }
        };

        window.openDetails = async (id) => {
            const modal = document.getElementById('details-modal');
            const titleEl = document.getElementById('modal-title');
            const dateEl = document.getElementById('modal-date');
            const descEl = document.getElementById('modal-desc');
            const statusBadge = document.getElementById('modal-status-badge');
            const formatBadge = document.getElementById('modal-format-badge');
            const formatDesc = document.getElementById('modal-format-desc');
            const adminControls = document.getElementById('modal-admin-controls');
            const joinArea = document.getElementById('modal-join-area');

            modal.classList.remove('hidden');
            titleEl.innerText = "Carregando...";
            
            const snap = await getDoc(doc(db, "tournaments", id));
            if (!snap.exists()) { modal.classList.add('hidden'); return; }
            const d = snap.data();

            titleEl.innerText = d.title;
            dateEl.innerText = d.date;
            descEl.innerText = d.description;
            
            // Format Info
            const matchText = FORMAT_INFO.matches[d.matchFormat] || '';
            formatBadge.innerText = d.matchFormat ? d.matchFormat.toUpperCase() : 'GERAL';
            formatDesc.innerText = matchText;

            let statusTag = `<span class="px-2 py-1 rounded text-xs font-bold bg-green-500/10 text-green-500 border border-green-500/20">ABERTO PARA INSCRI√á√ïES</span>`;
            if (d.status === 'pending') statusTag = `<span class="px-2 py-1 rounded text-xs font-bold bg-yellow-500/10 text-yellow-500 animate-pulse">PROCESSANDO...</span>`;
            if (d.status === 'started') statusTag = `<span class="px-2 py-1 rounded text-xs font-bold bg-red-500/10 text-red-500 border border-red-500/20 animate-pulse">üî¥ EM ANDAMENTO</span>`;
            statusBadge.innerHTML = statusTag;

            const parts = d.participants || [];
            const filterParts = (s) => parts.filter(p => p.status === s);
            
            const fillList = (id, list) => {
                const el = document.getElementById(id);
                const countEl = document.getElementById('count-' + id.split('-')[1]);
                el.innerHTML = "";
                countEl.innerText = list.length;
                if(list.length === 0) el.innerHTML = "<span class='text-slate-600 italic text-xs'>Ningu√©m</span>";
                list.forEach(p => {
                    el.innerHTML += `
                        <div class="flex justify-between items-center bg-slate-800/50 p-2 rounded border border-slate-700/50">
                            <span class="text-slate-300">${p.name}</span>
                            ${p.reason ? `<i class="fas fa-info-circle text-slate-500 cursor-help" title="${p.reason}"></i>` : ''}
                        </div>`;
                });
            };

            fillList('list-confirmed', filterParts('confirmed'));
            fillList('list-maybe', filterParts('maybe'));
            fillList('list-declined', filterParts('declined'));

            adminControls.innerHTML = "";
            adminControls.classList.add('hidden');
            if (userHasPermission) {
                adminControls.classList.remove('hidden');
                if (d.status !== 'started') {
                    adminControls.innerHTML += `<button onclick="window.openStartModal('${id}')" class="bg-green-600 hover:bg-green-500 text-white px-3 py-1 rounded text-sm font-bold shadow transition"><i class="fas fa-play mr-1"></i> Iniciar</button>`;
                }
                adminControls.innerHTML += `<button onclick="window.deleteTournament('${id}')" class="bg-red-600 hover:bg-red-500 text-white px-3 py-1 rounded text-sm font-bold shadow transition"><i class="fas fa-trash mr-1"></i> Excluir</button>`;
            }

            const myId = auth.currentUser ? auth.currentUser.uid : null;
            const amIIn = parts.some(p => p.id === myId && p.status === 'confirmed');
            
            if (d.status !== 'started') {
                if (amIIn) {
                    joinArea.innerHTML = `<div class="w-full bg-green-900/30 border border-green-500/30 text-green-400 py-3 rounded-lg text-center font-bold"><i class="fas fa-check-circle mr-2"></i> Voc√™ est√° confirmado!</div>`;
                } else {
                    joinArea.innerHTML = `<button onclick="window.joinTournament('${id}')" class="w-full bg-blue-600 hover:bg-blue-500 text-white font-bold py-3 rounded-lg shadow-lg transition transform hover:scale-[1.01]">Confirmar Presen√ßa</button>`;
                }
            } else {
                joinArea.innerHTML = `<div class="text-center text-slate-500 text-sm italic">Inscri√ß√µes encerradas.</div>`;
            }
        };

        els.confirmStartBtn.onclick = async () => {
            const id = document.getElementById('start-doc-id').value;
            // Pega os valores possivelmente editados
            const matchFormat = document.getElementById('start-match-format').value;
            const structure = document.getElementById('start-structure').value;
            const shuffle = document.getElementById('start-shuffle').value;
            const logicMode = document.getElementById('start-logic-mode').value;
            
            els.confirmStartBtn.innerText = "Gerando..."; els.confirmStartBtn.disabled = true;
            try {
                const docRef = doc(db, "tournaments", id);
                const snap = await getDoc(docRef);
                if (!snap.exists()) throw new Error("Torneio n√£o existe.");
                
                let players = (snap.data().participants || []).filter(p => p.status === 'confirmed').map(p => ({ id: p.id, name: p.name }));
                if (players.length < 2) throw new Error("M√≠nimo de 2 participantes confirmados.");

                // L√≥gica de Embaralhamento (Se for random)
                if (shuffle === 'random' || shuffle === 'random_protected') {
                    for (let i = players.length - 1; i > 0; i--) {
                        const j = Math.floor(Math.random() * (i + 1));
                        [players[i], players[j]] = [players[j], players[i]];
                    }
                }

                let matches = [];
                // Se a l√≥gica escolhida for "Mata-Mata (Chaves)"
                if (logicMode === 'elimination') {
                    const totalMatches = Math.floor(players.length / 2);
                    for(let i=0; i<totalMatches; i++) {
                        matches.push({ round: 1, matchId: i+1, p1: players[i*2], p2: players[i*2+1], winner: null });
                    }
                    if (players.length % 2 !== 0) {
                        matches.push({ round: 1, matchId: totalMatches + 1, p1: players[players.length - 1], p2: null, winner: players[players.length - 1].id, note: "Bye" });
                    }
                }

                await updateDoc(docRef, { 
                    status: 'started', 
                    startedAt: new Date(), 
                    // Salva as configura√ß√µes finais usadas
                    matchFormat: matchFormat,
                    structure: structure,
                    shuffle: shuffle,
                    logicMode: logicMode,
                    matches: matches, 
                    finalParticipants: players 
                });
                els.startModal.classList.add('hidden');
                window.showToast("Torneio iniciado com sucesso!", "success");
                window.openDetails(id);
            } catch(e) { window.showToast("Erro: " + e.message, "error"); }
            finally { els.confirmStartBtn.innerText = "INICIAR"; els.confirmStartBtn.disabled = false; }
        };

        function startTournamentListener() {
            const list = document.getElementById('tournaments-list');
            document.getElementById('loader-tournaments').classList.remove('hidden');
            
            onSnapshot(query(collection(db, "tournaments"), orderBy("createdAt", "desc")), snapshot => {
                document.getElementById('loader-tournaments').classList.add('hidden');
                list.innerHTML = "";
                if (snapshot.empty) return list.innerHTML = `<div class="col-span-full text-center text-slate-500 py-10">Nenhum evento.</div>`;

                snapshot.forEach(doc => {
                    const d = doc.data();
                    if(d.status === 'finished') return;

                    const conf = (d.participants||[]).filter(p=>p.status==='confirmed').length;
                    
                    let statusTag = `<span class="px-2 py-0.5 rounded text-[10px] font-bold bg-green-500/10 text-green-500 border border-green-500/20">ABERTO</span>`;
                    if (d.status === 'pending') statusTag = `<span class="px-2 py-0.5 rounded text-[10px] font-bold bg-yellow-500/10 text-yellow-500 animate-pulse">...</span>`;
                    if (d.status === 'started') statusTag = `<span class="px-2 py-0.5 rounded text-[10px] font-bold bg-red-500/10 text-red-500 border border-red-500/20">AO VIVO</span>`;

                    // Formato Badge
                    const formatLabel = d.matchFormat ? d.matchFormat.toUpperCase() : 'GERAL';

                    list.innerHTML += `
                        <div onclick="window.openDetails('${doc.id}')" class="bg-slate-800 rounded-xl border border-slate-700 hover:border-yellow-500/50 transition duration-300 group overflow-hidden flex flex-col h-full shadow-lg cursor-pointer relative transform hover:-translate-y-1">
                            <div class="p-5 flex-grow relative">
                                <div class="absolute top-0 right-0 p-4 opacity-5 pointer-events-none"><i class="fas fa-trophy text-6xl text-yellow-500"></i></div>
                                <div class="flex justify-between items-start mb-4">
                                    ${statusTag} 
                                    <div class="flex gap-1">
                                        <span class="text-[10px] font-mono bg-slate-700 px-1 rounded text-slate-300">${formatLabel}</span>
                                        <span class="text-xs text-slate-500 font-mono">#${doc.id.substr(0,4)}</span>
                                    </div>
                                </div>
                                <h3 class="font-bold text-lg text-white mb-2 leading-tight">${d.title}</h3>
                                <div class="flex items-center gap-2 text-xs text-yellow-500 font-medium mb-4 bg-slate-900/50 w-fit px-2 py-1 rounded"><i class="far fa-clock"></i> ${d.date}</div>
                                <p class="text-slate-400 text-sm line-clamp-3 mb-4 border-l-2 border-slate-700 pl-3">${d.description}</p>
                            </div>
                            <div class="bg-slate-900/50 border-t border-slate-700/50 p-3 flex justify-between items-center text-xs text-slate-400">
                                <span><i class="fas fa-users text-green-500 mr-1"></i> <b>${conf}</b> Confirmados</span>
                                <span class="text-yellow-500 hover:underline">Ver detalhes <i class="fas fa-arrow-right ml-1"></i></span>
                            </div>
                        </div>
                    `;
                });
            });
        }
    </script>
</body>
</html>
